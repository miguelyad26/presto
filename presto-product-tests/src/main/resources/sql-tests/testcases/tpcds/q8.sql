-- database: presto; groups: tpcds
SELECT s_store_name ,
       sum(ss_net_profit)
FROM "tpcds"."sf1".store_sales ,
     "tpcds"."sf1".date_dim ,
     "tpcds"."sf1".store,

  (SELECT ca_zip
   FROM (
           (SELECT substr(ca_zip,1,5) ca_zip
            FROM "tpcds"."sf1".customer_address
            WHERE substr(ca_zip,1,5) IN ( '17839',
                                          '58830',
                                          '39893',
                                          '33619',
                                          '77101',
                                          '20014',
                                          '17004',
                                          '63543',
                                          '73712',
                                          '44271',
                                          '58024',
                                          '17426',
                                          '22133',
                                          '44778',
                                          '21277',
                                          '61691',
                                          '65419',
                                          '23758',
                                          '18489',
                                          '79070',
                                          '59559',
                                          '63778',
                                          '25622',
                                          '22278',
                                          '59685',
                                          '56976',
                                          '85608',
                                          '46387',
                                          '46304',
                                          '13249',
                                          '57621',
                                          '43189',
                                          '20679',
                                          '32952',
                                          '34074',
                                          '71624',
                                          '36238',
                                          '20812',
                                          '52575',
                                          '79654',
                                          '35460',
                                          '12594',
                                          '10828',
                                          '45215',
                                          '76251',
                                          '80759',
                                          '97450',
                                          '79993',
                                          '49017',
                                          '69033',
                                          '52567',
                                          '94598',
                                          '78733',
                                          '55953',
                                          '81231',
                                          '52222',
                                          '67451',
                                          '45482',
                                          '17439',
                                          '67161',
                                          '41530',
                                          '61081',
                                          '71075',
                                          '42292',
                                          '92177',
                                          '28887',
                                          '37323',
                                          '83002',
                                          '53454',
                                          '50456',
                                          '35622',
                                          '64349',
                                          '14526',
                                          '99297',
                                          '64556',
                                          '31321',
                                          '96780',
                                          '46202',
                                          '31870',
                                          '30594',
                                          '47038',
                                          '48421',
                                          '46076',
                                          '70268',
                                          '61742',
                                          '11152',
                                          '25110',
                                          '68857',
                                          '79662',
                                          '98300',
                                          '88965',
                                          '10678',
                                          '89021',
                                          '10381',
                                          '27980',
                                          '36501',
                                          '97455',
                                          '78854',
                                          '17086',
                                          '22255',
                                          '90417',
                                          '77545',
                                          '36960',
                                          '14475',
                                          '30965',
                                          '54148',
                                          '20333',
                                          '34504',
                                          '89607',
                                          '55754',
                                          '53600',
                                          '92398',
                                          '80100',
                                          '66017',
                                          '22249',
                                          '44814',
                                          '63459',
                                          '35814',
                                          '21361',
                                          '68540',
                                          '26960',
                                          '33394',
                                          '97677',
                                          '69780',
                                          '15018',
                                          '44000',
                                          '61608',
                                          '31301',
                                          '34301',
                                          '53882',
                                          '90384',
                                          '24643',
                                          '23542',
                                          '91658',
                                          '80556',
                                          '74377',
                                          '19342',
                                          '18800',
                                          '19881',
                                          '69939',
                                          '45206',
                                          '95816',
                                          '30808',
                                          '61399',
                                          '19749',
                                          '92619',
                                          '91892',
                                          '56698',
                                          '19827',
                                          '56349',
                                          '27102',
                                          '23044',
                                          '72809',
                                          '45133',
                                          '68894',
                                          '97613',
                                          '58977',
                                          '79757',
                                          '68014',
                                          '69959',
                                          '15025',
                                          '21508',
                                          '43949',
                                          '56008',
                                          '98738',
                                          '99885',
                                          '13925',
                                          '38365',
                                          '36400',
                                          '31122',
                                          '34086',
                                          '22932',
                                          '57498',
                                          '17412',
                                          '43786',
                                          '88581',
                                          '40815',
                                          '37969',
                                          '69198',
                                          '30779',
                                          '89888',
                                          '96849',
                                          '66217',
                                          '30875',
                                          '11762',
                                          '95371',
                                          '46705',
                                          '72525',
                                          '57515',
                                          '31305',
                                          '41474',
                                          '76187',
                                          '31216',
                                          '69007',
                                          '56783',
                                          '13702',
                                          '52383',
                                          '37630',
                                          '44935',
                                          '11272',
                                          '85369',
                                          '88062',
                                          '57257',
                                          '59895',
                                          '19130',
                                          '31921',
                                          '80503',
                                          '47826',
                                          '11646',
                                          '13830',
                                          '29434',
                                          '27948',
                                          '40202',
                                          '57031',
                                          '44638',
                                          '14667',
                                          '42220',
                                          '29521',
                                          '60723',
                                          '39277',
                                          '54417',
                                          '20561',
                                          '35895',
                                          '23312',
                                          '39677',
                                          '77911',
                                          '25561',
                                          '64722',
                                          '92544',
                                          '35538',
                                          '34727',
                                          '20433',
                                          '55608',
                                          '32104',
                                          '23585',
                                          '47779',
                                          '96266',
                                          '79765',
                                          '40008',
                                          '94180',
                                          '81244',
                                          '75008',
                                          '19669',
                                          '28488',
                                          '53225',
                                          '71008',
                                          '34419',
                                          '76265',
                                          '35038',
                                          '18509',
                                          '37341',
                                          '41080',
                                          '63117',
                                          '80901',
                                          '88164',
                                          '54764',
                                          '88362',
                                          '59714',
                                          '24872',
                                          '68187',
                                          '29622',
                                          '48820',
                                          '56685',
                                          '60113',
                                          '78923',
                                          '41862',
                                          '41507',
                                          '95259',
                                          '73742',
                                          '82730',
                                          '18589',
                                          '28073',
                                          '37402',
                                          '61616',
                                          '89676',
                                          '14246',
                                          '28986',
                                          '21429',
                                          '79921',
                                          '31174',
                                          '87018',
                                          '96039',
                                          '57922',
                                          '11714',
                                          '42490',
                                          '22919',
                                          '77729',
                                          '27662',
                                          '25503',
                                          '75504',
                                          '91699',
                                          '50931',
                                          '61209',
                                          '17148',
                                          '67336',
                                          '37403',
                                          '73582',
                                          '56347',
                                          '22916',
                                          '39788',
                                          '93072',
                                          '17711',
                                          '65145',
                                          '87910',
                                          '99120',
                                          '70446',
                                          '18273',
                                          '24174',
                                          '49652',
                                          '84191',
                                          '10980',
                                          '12393',
                                          '95347',
                                          '29405',
                                          '93781',
                                          '13505',
                                          '73759',
                                          '79423',
                                          '22080',
                                          '12737',
                                          '76347',
                                          '82170',
                                          '50888',
                                          '96752',
                                          '22673',
                                          '71087',
                                          '17692',
                                          '12037',
                                          '16516',
                                          '13935',
                                          '26923',
                                          '87079',
                                          '75080',
                                          '24980',
                                          '80201',
                                          '74179',
                                          '40229',
                                          '11530',
                                          '69766',
                                          '39796',
                                          '56673',
                                          '95062',
                                          '37622',
                                          '78476',
                                          '55936',
                                          '72521',
                                          '87306',
                                          '53160',
                                          '16478',
                                          '64542',
                                          '59799',
                                          '22728',
                                          '18349',
                                          '79035',
                                          '23975',
                                          '37071',
                                          '19661',
                                          '87377',
                                          '76802',
                                          '69264',
                                          '35964',
                                          '51982',
                                          '47169',
                                          '93110',
                                          '99161',
                                          '91066',
                                          '98870',
                                          '19510',
                                          '37251',
                                          '33161',
                                          '63313',
                                          '29684',
                                          '43624',
                                          '15934',
                                          '87035',
                                          '81794',
                                          '51994',
                                          '46793',
                                          '12131',
                                          '87287',
                                          '97672',
                                          '13743',
                                          '56681',
                                          '10388',
                                          '59738',
                                          '94450',
                                          '17543',
                                          '61735',
                                          '16910',
                                          '65016',
                                          '60996',
                                          '41077',
                                          '57448',
                                          '27561',
                                          '97416',
                                          '80793',
                                          '83226',
                                          '63891',
                                          '55136',
                                          '97759')) INTERSECT
           (SELECT ca_zip
            FROM
              (SELECT substr(ca_zip,1,5) ca_zip,
                      count(*) cnt
               FROM "tpcds"."sf1".customer_address,
                    "tpcds"."sf1".customer
               WHERE ca_address_sk = c_current_addr_sk
                 AND c_preferred_cust_flag='Y'
               GROUP BY ca_zip
               HAVING count(*) > 10)a1))a2) v1
WHERE ss_store_sk = s_store_sk
  AND ss_sold_date_sk = d_date_sk
  AND d_qoy = 1
  AND d_year = 2002
  AND (substr(s_zip,1,2) = substr(v1.ca_zip,1,2))
GROUP BY s_store_name
ORDER BY s_store_name LIMIT 100;
